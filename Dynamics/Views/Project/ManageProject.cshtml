@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@using Microsoft.AspNetCore.Authorization
@inject IHttpContextAccessor Accessor
@inject IProjectMemberRepository ProjectMemberRepository
@model Dynamics.Models.Models.ViewModel.DetailProjectVM
@{
    ViewData["Title"] = "Manage Project";
    Layout = "~/Views/Shared/_LayoutProject.cshtml";
    // take current user
    var userIDString = Accessor.HttpContext.Session.GetString("currentUserID");
    var currentProjectID = Accessor.HttpContext.Session.GetString("currentProjectID");
    var allProjectMember = ProjectMemberRepository.FilterProjectMember(p => p.ProjectID.Equals(new Guid(currentProjectID)));

    Report report = new Report();
    List<ProjectMember> ProjectMemberOfUser = null;
    int? statusProjectMemberOfUser = -1;

    if (!string.IsNullOrEmpty(userIDString))
    {    
        ProjectMemberOfUser = ProjectMemberRepository.FilterProjectMember(p => p.ProjectID.Equals(new Guid(currentProjectID)) && p.UserID.Equals(new Guid(userIDString)));
        if (ProjectMemberOfUser.Count()>0)
        {
            statusProjectMemberOfUser = ProjectMemberOfUser?.FirstOrDefault()?.Status;
        }
    }
         
   
    string[] projectImages = new string[1] { ","};
    if (Model.CurrentProject.Attachment != null)
    {
        projectImages = Model.CurrentProject.Attachment.TrimEnd(',', ' ').Split(",");
    }
    
}

<!-- container start -->
<div class="m-w-screen-2xl ml-20 flex  justify-start relative">
    @if (statusProjectMemberOfUser>=2)
    {
        <!-- edit button -->
        <a asp-action="UpdateProjectProfile" asp-route-id="@Model.CurrentProject.ProjectID" title="Edit project profile">
            <button type="button"
            class="absolute  w-fit h-fit mx-2  p-2 top-2 " style="right:-5px;">
                <i class="fa-solid fa-pen-to-square text-3xl text-gray-900"></i>
            </button>
        </a>
    }
    <div class="relative my-12  flex flex-col text-xl" style="width: 66%">
        <!-- part 1-image -->
        <div class="ml-0  w-full justify-center items-center">
            <div class="relative items-center">
                <!-- Main image container -->
                <div id="carousel" class="w-full bg-gray-300 rounded-lg overflow-hidden" style="height:32rem;">
                    <!-- Images will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Indicator dots  -->
            <div class="flex justify-center my-10 mt-4 space-x-2 relative">
                <!-- Navigation buttons -->
                
                @foreach (var img in projectImages)
                {
                    <div onclick="updateCarouselAsUserWant('@img')" class=" relative w-20 h-20 bg-gray-300 rounded-xl mr-2 hover:ring-4 hover:ring-blue-500 cursor-pointer">
                        <img src="@img" class="w-full h-full items-center rounded-xl">
                        </div>
                }
                <button id="prevBtn"
                        class="absolute top-10  transform -translate-y-1/2 bg-white rounded-full p-2 shadow-md" style="left:14rem;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </button>
                <button id="nextBtn"
                        class="absolute top-10 transform -translate-y-1/2 bg-white rounded-full p-2 shadow-md" style="right:14rem;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- end part 1-image -->
        <div class="border-t p-6 ">
            <h2 class="font-semibold mb-2 text-black text-2xl">Contact Information:</h2>
            <p class="text-gray-600  text-md">✉ @Model.CurrentProject.ProjectEmail</p>
            <p class="text-gray-600  text-md">📞 @Model.CurrentProject.ProjectPhoneNumber</p>
            <p class="text-gray-600  text-md">🏠 @Model.CurrentProject.ProjectAddress</p>
        </div>
            <div class="border-t p-4 mt-0">
                <h2 class="font-semibold mb-2 text-black text-2xl">Timeline</h2>
                <p class="text-gray-600  text-md">Start Date: @Model.CurrentProject.StartTime</p>
                <p class="text-gray-600  text-md">End Date: @Model.CurrentProject.EndTime</p>
            @if (Model.CurrentProject.ProjectStatus == -1)
                    {
                    <p class="text-gray-600  text-md">Status: <span class="text-red-700 font-semibold">Inactive</span></p>
                    }else if
                
                (Model.CurrentProject.ProjectStatus== 0)
                {
                <p class="text-gray-600  text-md">Status: <span class="text-red-700 font-semibold">Preparing</span></p>
            }
            else if(Model.CurrentProject.ProjectStatus==1)
            {
                <p class="text-gray-600  text-md">Status: <span class="text-red-700 font-semibold">In progress</span></p>
            }
            else if (Model.CurrentProject.ProjectStatus == 2)
            {
                <p class="text-gray-600  text-md">Status: <span class="text-red-700 font-semibold">Completed</span></p>
                }
            </div>
        <div class="border-t p-4 mt-0">
            <h2 class="font-semibold mb-2 text-black text-2xl">Description</h2>

            <details id="descriptionDetails" class="collapse bg-base-200">
            <summary  class="collapse-title text-md font-medium cursor-pointer">
                <div id="description-container" class="cursor-pointer" onclick="toggleDescription()">
                <p class="text-gray-600 text-md line-clamp-3" id="summaryText">
                    @Model.CurrentProject.ProjectDescription
                </p>
                <p class="hidden" id="fullText">
                    @Model.CurrentProject.ProjectDescription
                </p>
                </div>
            </summary>
        </details>
        </div>
        <div class="border-t p-4 mt-0">
            <h2 class="font-semibold mb-2 text-black text-2xl">Organizer</h2>
            <div class="flex justify-start">
                <div>
                    <img class="rounded-full w-14 h-14 mx-4 mb-4"
                             src="@Model.CurrentLeaderProject.UserAvatar"
                         alt="avatar">
                </div>
                <div class="flex flex-col ">
                    <p class="text-gray-600 font-normal">
                        Project leader: <span class="text-black font-bold  text-md">
                           @Model.CurrentLeaderProject.UserFullName
                        </span>
                    </p>
                        <p class="text-gray-400 font-normal  text-md ">Address: @Model.CurrentLeaderProject.UserAddress</p>
                </div>
            </div>
            @if (Model.CurrentProject.Request != null)
            {
                <div class="flex justify-start">
                    <div>
                        <img class="rounded-full w-14 h-14 mx-4 mb-4"
                             src="@Model.CurrentProject.Request?.User.UserAvatar"
                             alt="avatar">
                    </div>
                    <div class="flex flex-col ">
                        <p class="text-gray-600 font-normal">
                            Requester: <span class="text-black font-bold  text-md">
                                @Model.CurrentProject.Request?.User.UserFullName
                            </span>
                        </p>
                        <p class="text-gray-400 font-normal  text-md ">Address: @Model.CurrentProject.Request?.User.UserAddress</p>
                    </div>
                </div>
            }          
        </div>
        @if (Model.Random5Donors.Count > 0)
        {
            <div class="border-t p-4 mt-0">
                <h2 class="font-semibold mb-2 text-black text-2xl">Donors</h2>
        <div class="overflow-x-auto">
            <table class="table table-md">
                <thead class="bg-gray-300/20 ">
                    <tr class="text-gray-900 ">
                        <th></th>
                        <th class="text-xl">Date</th>
                        <th class="text-xl">Name</th>
                        <th class="text-xl">Resource Name</th>
                        <th class="text-xl">Quantity</th>
                        <th class="text-xl">Unit</th>
                        <th class="text-xl">Message</th>
                        <th class="text-xl">Status</th>
                        <th class="text-xl">Action</th>
                    </tr>
                </thead>
                <tbody >
                       @for (int i = 0;i< Model.Random5Donors.Count();i++)
                    {
                        var item =  Model.Random5Donors.ElementAt(i);
                        <tr class="hover:bg-slate-50">
                            <td class="p-2 text-lg">@(i + 1)</td>
                            <td class="p-2 text-lg">@item.Time</td>
                            <td class="p-2 text-lg">@item.User.UserFullName</td>
                            <td class="p-2 text-lg">@item.ProjectResource.ResourceName</td>
                            <td class="p-2 text-lg">@item.Amount</td>
                            <td class="p-2 text-lg">@item.ProjectResource.Unit</td>
                            <td class="p-2 text-lg">@item.Message</td>
                            <td class="p-2 ">
                                <div class="w-fit">
                                        @if (item.Status == 1)
                                        {
                                        <div class="relative grid items-center px-2 py-1 font-sans font-bold text-green-900 uppercase rounded-md select-none whitespace-nowrap bg-green-500/20">

                                                <span class="">Accepted</span>
                                        </div>

                                        }else if(item.Status == -1)
                                        {
                                        <div class="relative grid items-center px-2 py-1 font-sans font-bold text-red-900 uppercase rounded-md select-none whitespace-nowrap bg-red-500/20">
                                            <span class="">Denied</span>
                                        </div>
                                        }
                                </div>
                            </td>
                            <td>
                                <button type="button" onClick="document.getElementById('proofImagesModal_@item.TransactionID').showModal()" class="py-2 px-4 border border-solid border-gray-300 shadow-sm rounded-md m-1 bg-gray-100 text-black font-bold">View proof images</button>
                                <!-- You can open the modal using ID.showModal() method -->
                                <dialog id="proofImagesModal_@item.TransactionID" class="modal">
                                    <div class="modal-box w-11/12 max-w-5xl">
                                        <h2 class=" text-black font-bold text-3xl text-center mb-4">Proof images</h2>
                                        @{
                                            string[] proofImages = new string[1] { "," };
                                            if (item.Attachments != null)
                                            {
                                                proofImages = item.Attachments.TrimEnd(',', ' ').Split(",");
                                            }
                                        }
                                        <div class="flex flex-wrap items-start gap-6" style="height:50vh;">
                                            @foreach (var img in proofImages)
                                            {
                                                <button onclick="openModal('@img','proof_image')">
                                                    <img src="@img" alt="proof-img" class="h-40 w-40 rounded-xl shadow-md cursor-pointer" />
                                                </button>
                                                <dialog id="proof_image" class="modal">
                                                    <div class="modal-box w-fit h-fit  p-0 m-0" style=" background-color: rgba(0, 0, 0, 0);">
                                                        <img id="modalImage" alt="current-phase-img" class="h-[80vh] w-auto rounded-xl shadow-md cursor-pointer" />
                                                    </div>
                                                    <form method="dialog" class="modal-backdrop ">
                                                        <button>close</button>
                                                    </form>
                                                </dialog>
                                            }
                                        </div>

                                    </div>
                                    <form method="dialog" class="modal-backdrop">
                                        <button>close</button>
                                    </form>
                                </dialog>
                            </td>
                    </tr>
        }
                </tbody>
            </table>
        </div>

                <a asp-action="ManageProjectDonor" asp-route-projectID="@currentProjectID" class="text-gray-400 flex justify-center font-normal">See more donors...</a>
              </div>
        }       

</div>
    <!-- part 1-fundraising -->
    <!-- when using fixed+relative, need to modify top-bottom-left-right to specify the object at fixed/absolute -->
        <div  class="sticky top-20 right-15 h-fit ml-12 mr-20 " style="width:28%;">
    <div class=" flex flex-col text-4xl justify-start shadow-2xl p-6 my-10 mx-2 rounded-3xl bg-white w-full">
        <span class=" font-bold text-green-500 p-2 tex-6xl">Raised @Model.CurrentAmountOfMoneyDonate VND</span>
        <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700 ">
            <div class="bg-green-500 h-3 rounded-full" style="width: @(Model.ProgressDonate >=100?100:Model.ProgressDonate)%"></div>       
        </div>
        <span class=" font-normal text-gray-500 p-2 text-2xl">
            pledged of <span class="font-bold text-black text-4xl">@Model.ExpectedAmountOfMoneyDonate</span> VND goal
        </span>

        <div class="flex font-normal text-gray-500 flex-col p-2 text-2xl">
            <span class="text-black font-bold text-4xl">@Model.NumberOfProjectContributor</span>
            <div>Contributors</div>
        </div>
        <div class="flex font-normal text-gray-500 flex-col p-2 text-2xl">
            <span class="text-black font-bold text-4xl">@Model.TimeLeftEndDay</span>
            <div>days till the end</div>
        </div>
        <a asp-action="SendDonateRequest" asp-route-projectid="@currentProjectID" asp-route-donor="User">
                <button type="button" style="width:98%;"
                class="text-gray-900 bg-green-500 from-teal-200 to-lime-200 hover:bg-gradient-to-l hover:from-teal-200 hover:to-lime-200 focus:ring-4 focus:outline-none focus:ring-lime-200 dark:focus:ring-teal-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">
            Donate
            this project
        </button>
            </a>
            @if (statusProjectMemberOfUser == -1)
            {
                <a asp-action="JoinProjectRequest" asp-route-memberid="@(!string.IsNullOrEmpty(userIDString)?new Guid(userIDString):Guid.Empty)" asp-route-projectid="@currentProjectID">
                    <button style="width:98%;" class=" relative inline-flex items-center justify-center p-0.5 mb-2 me-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600 group-hover:from-green-400 group-hover:to-blue-600 hover:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                        <span class="relative w-full px-5 py-2.5  transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0">
                        Join this project
                    </span>
                </button>
                </a>
            }
            else if (statusProjectMemberOfUser == 0)
            {
                <a asp-action="JoinProjectRequest" asp-route-memberid="@(new Guid(userIDString))" asp-route-projectid="@currentProjectID">
                    <button style="width:98%;" class=" relative inline-flex items-center justify-center p-0.5 mb-2 me-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600 group-hover:from-green-400 group-hover:to-blue-600 hover:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                        <span class=" relative w-full px-5 py-2.5  transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0">
                            Processing join request
                        </span>
                    </button>
                </a>           
            }
            else if (statusProjectMemberOfUser == -2)
            {
                <a asp-action="AcceptJoinInvitation" asp-route-memberid="@(new Guid(userIDString))" asp-route-projectid="@currentProjectID">
                    <button style="width:98%;" class=" relative inline-flex items-center justify-center p-0.5 mb-2 me-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600 group-hover:from-green-400 group-hover:to-blue-600 hover:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                        <span class=" relative w-full px-5 py-2.5  transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0">
                            Accept invitation
                        </span>
                    </button>
                </a>
            }
            else if (statusProjectMemberOfUser >= 1)
            {
                <a asp-action="LeaveProjectRequest" asp-route-memberid="@(new Guid(userIDString))" asp-route-projectid="@currentProjectID">
                    <button style="width:98%;"class="  relative inline-flex items-center justify-center p-0.5 mb-2 me-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-green-400 to-blue-600 group-hover:from-green-400 group-hover:to-blue-600 hover:text-white focus:ring-4 focus:outline-none focus:ring-green-200 dark:focus:ring-green-800">
                        <span class="relative w-full px-5 py-2.5 transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0">
                            Leave this project
                        </span>
                    </button>
                </a>
            }

            <button onclick="@(User.Identity.IsAuthenticated ? "ReportModal.showModal()" : $"window.location.href='/Identity/Account/Login?returnUrl={Uri.EscapeDataString($"~/Project/ManageProject?id={currentProjectID}")}'")" type="button" class="relative inline-flex items-center justify-center p-0.5 mb-2 me-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-pink-500 to-orange-400 group-hover:from-pink-500 group-hover:to-orange-400 hover:text-white focus:ring-4 focus:outline-none focus:ring-pink-200 dark:focus:ring-pink-800">
                <span class="relative w-full px-5 py-2.5 transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0">
                Report
            </span>
        </button>

    </div>
   
        </div>
        @* alternative form *@
    <!-- Open the modal using ID.showModal() method -->

    <dialog id="ReportModal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <div class="modal-action  flex flex-col">
                <h2 class="font-serif text-black font-bold text-3xl text-center mb-4">Report project</h2>
                <form method="post" asp-action="SendReportProjectRequest" asp-controller="Project">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="@report.ObjectID" value="@currentProjectID" />
                    <div class="grid grid-cols-1 gap-y-3">
                        <div>
                            <label asp-for="@report.Reason" class="block mb-2 text-md font-medium text-gray-900">Enter reason to report project</label>
                            <textarea asp-for="@report.Reason" id="Reason" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-white bg-opacity-70 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 " placeholder="Write reason here..."></textarea>
                            <span asp-validation-for="@report.Reason" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="flex justify-center items-center gap-x-6">
                        <button type="submit"
                                class="mt-4 text-md text-white bg-red-500 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg w-full sm:w-auto px-5 py-2.5 text-center">
                            Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
                                        <button>close</button>
                                    </form>
    </dialog>


</div>

<script>
    @*  modal *@
     function openModal(imgSrc,modalid) {
        document.getElementById('modalImage').src = imgSrc;
        document.getElementById(modalid).showModal();
    }
       

    @* handle carousel *@
    const carousel = document.getElementById('carousel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const images = @Html.Raw(Json.Serialize(projectImages));

    let currentIndex = 0;

    function updateCarouselAsUserWant(src) {
        // Update the carousel with the selected image
        carousel.innerHTML = `<img src="${src}" class="w-full object-cover items-center cursor-pointer" alt="Project image" style="height: 40rem;">`;

        const srcFilename = src.split('/').pop(); // Get the file name from the src
        const indicators = document.querySelectorAll('.flex.justify-center.mt-4.space-x-2 > div > img');

        // Loop through each indicator to compare its src with the selected image src
        indicators.forEach((indicator) => {
            const indicatorFilename = indicator.src.split('/').pop(); // Get the file name from the indicator src

            // Compare the filenames of the indicator's img and the selected image
            if (indicatorFilename === srcFilename) {
                // Apply special class to highlight the current image (e.g., a mask or border)
                indicator.classList.add('ring-4', 'ring-blue-500');
            } else {
                // Remove the highlight from other images
                indicator.classList.remove('ring-4', 'ring-blue-500');
            }
        });
    }
    function updateCarousel() {
        carousel.innerHTML = `<img src="${images[currentIndex]}" class="w-full object-cover items-center" alt="Project image" style="height: 40rem;">`;
        updateIndicators();
    }

    function updateIndicators() {
        // Select all the image indicators
        const indicators = document.querySelectorAll('.flex.justify-center.mt-4.space-x-2 > div > img');
        indicators.forEach((indicator, index) => {
            if (index === currentIndex) {
                // Apply special class to highlight the current image (e.g., a mask or border)
                indicator.classList.add('ring-4', 'ring-blue-500');
            } else {
                // Remove the highlight from other images
                indicator.classList.remove('ring-4', 'ring-blue-500');
            }
        });
    }

    prevBtn.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        updateCarousel();
    });

    nextBtn.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % images.length;
        updateCarousel();
    });

    // Initialize the carousel
    updateCarousel();
    @* view more RTCSessionDescription *@


function toggleDescription() {
    const summaryText = document.getElementById('summaryText');
    const fullText = document.getElementById('fullText').textContent;

    if (summaryText.classList.contains('line-clamp-3')) {
        // Hiển thị toàn bộ nội dung
        summaryText.classList.remove('line-clamp-3');
        summaryText.textContent = fullText;
    } else {
        // Thu gọn nội dung
        summaryText.classList.add('line-clamp-3');
        summaryText.textContent = fullText;
    }
}


</script>